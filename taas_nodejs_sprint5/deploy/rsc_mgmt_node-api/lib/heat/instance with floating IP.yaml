heat_template_version: '2013-05-23'
outputs:
  server_networks_floatingIP:
    description: The floatingIP of the deployed server
    value:
      get_attr: [ floating_ip, floating_ip_address ]
      
  server_networks_publicIP:
    description: The networks of the deployed server
    value:
      get_attr: [ server, first_address ]
  
  
parameters:
  db_port:
    constraints:
    - description: Port number must be between 40000 and 60000
      range: {max: 60000, min: 40000}
    default: 50000
    description: Database port number
    type: number
  flavor:
    constraints:
    - {custom_constraint: nova.flavor}
    default: m1.small
    description: Flavor for the server to be created
    type: string
  image:
    constraints:
    - {custom_constraint: glance.image}
    description: Image ID or image name to use for the server
    type: string
  key_name:
    constraints:
    - {custom_constraint: nova.keypair}
    description: Name of an existing key pair to use for the server
    type: string
  network: {default: private, description: The network for the VM, type: string}
resources:
  server:
    properties:
      flavor: {get_param: flavor}
      image: {get_param: image}
      networks:
      - port: {get_resource: flasky_port}
      user_data:
        str_replace:
          params:
            db_port: {get_param: db_port}
          template: '#!/bin/bash
            
            echo db_port
           #cloud-config
           password: ccma
           chpasswd: { expire: False }
           ssh_pwauth: True

            '
    type: OS::Nova::Server
  flasky_port:
    type: OS::Neutron::Port
    properties:
      network: d3f74756-0623-4de5-8a2f-15a1412274c2
      security_groups: [default]
  floating_ip:
    type: OS::Neutron::FloatingIP
    properties:
      floating_network: 43c96b7b-64ed-4227-88e6-6ff7b536d62b
 

  floating_ip_assoc:
    type: OS::Neutron::FloatingIPAssociation
    properties:
      floatingip_id: { get_resource: floating_ip }
      port_id: { get_resource: flasky_port }