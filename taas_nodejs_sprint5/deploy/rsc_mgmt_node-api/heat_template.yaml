heat_template_version: '2014-10-16'
description: A template that starts the faafo application with auto-scaling workers
parameters:
  vm_spec_name:
    type: string
    description: stack identifier defined by user
  key_name:
    type: string
    description: Name of an existing keypair to enable SSH access to the instances
    default: sit_taas_heat
    constraints:
    - custom_constraint: nova.keypair
      description: Must already exist on your cloud
  flavor:
    type: string
    description: The flavor that the application uses
    default: m1.small
    constraints:
      - custom_constraint: nova.flavor
        description: Must be a valid flavor provided by your cloud provider.
  image:
    type: string
    description: The ID of the image to use to create the instance
    default: ubuntu14.04
    constraints:
      - custom_constraint: glance.image
        description: Must be a valid image on your cloud
  public_net:
    type: string
    description: ID or name of public network for which floating IP addresses will be allocated
    default: public
    constraints:
      - custom_constraint: neutron.network
        description: ID of an existing network
  private_net:
    type: string
    description: ID of private network
    constraints:
      - custom_constraint: neutron.network
        description: ID of an existing network
  num_instances:
    type: number
    description: Number of instances to create
    default: 2
resources:
  worker_auto_scaling_group:
    type: OS::Heat::AutoScalingGroup
    properties:
      resource:
        type: server_conf.yaml
        properties:
          public_net:
            get_param: public_net
          private_net:
            get_param: private_net
          flavor:
            get_param: flavor
          image:
            get_param: image
          key_name:
            get_param: key_name
      min_size: 1
      desired_capacity:
        get_param: num_instances
      max_size: 5
outputs:
  vm_spec_name:
    description: stack identifier defined by user
    value:
      get_param: vm_spec_name
  instance_amount:
    description: The amount of instances
    value:
      get_attr: [worker_auto_scaling_group, current_size]
  server_name:
    description: The name of instances
    value:
      get_attr: [worker_auto_scaling_group, outputs_list, server_name]
  floating_ip:
    description: The floating ip of instances
    value:
      get_attr: [worker_auto_scaling_group, outputs_list, floating_ip]
  private_ip:
    description: The private ip of instances
    value:
      get_attr: [worker_auto_scaling_group, outputs_list, private_ip]
